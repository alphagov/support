# Zendesk routing

## How tickets are published to Zendesk

Support app uses Support API as a client to communicate with Zendesk by calling the [`/support-tickets` endpoint](https://github.com/alphagov/support-api/blob/c0b6ca3587f6673c9512573deeecd66a2aaa0d98/app/controllers/support_tickets_controller.rb). `Services.support_api` is [instantiated in `app/lib/services.rb`](app/lib/services.rb). 
The endpoint is exposed via gds_api_adapters gem's [`.raise_support_ticket` method](https://github.com/alphagov/gds-api-adapters/blob/9aabf9d/lib/gds_api/support_api.rb#L25-L39), which is [invoked by the `ZendeskTicketJob`](https://github.com/alphagov/support/blob/a57843ea587a296a90958b97e5b07baf194c5bf1/app/workers/zendesk_ticket_worker.rb#L27). 

The `ZendeskTicketJob` is [created by the `ZendeskTickets` class](https://github.com/alphagov/support/blob/fdf8968f84231f2365207215e40cbaccad2fa6a1/app/models/zendesk/zendesk_tickets.rb#L15), which has a `raise_ticket` method that takes an object of type [`Zendesk::ZendeskTicket`](https://github.com/alphagov/support/blob/37fa7b05ec92511361b2a5e85f2c9f1a1bb3fb51/app/models/zendesk/zendesk_ticket.rb#L6) (or any child class thereof). `ZendeskTickets` is [instantiated in the `RequestsController`](https://github.com/alphagov/support/blob/564e53dc8a3d7a679b0c7f3ff52b91b3dd12e56d/app/controllers/requests_controller.rb#L36) on submission of one of the [live Support forms](https://support.publishing.service.gov.uk/) (one of the forms in the "User access", "Content request", "Technical support", "Campaigns", "Feedback for tools in Beta", "Topic taxonomy requests" or "Other requests" groups). The resulting ticket is tagged as per the `tag` method in whichever `Zendesk::ZendeskTicket` subclass it is, e.g. [`content_amend` tag for the `ContentChangeRequestTicket`](https://github.com/alphagov/support/blob/bcd9984967f70e5338b21455debb3ecd72684de3/app/models/zendesk/ticket/content_change_request_ticket.rb#L10-L12) as well as the default `govt_form` tag [present on the parent class](https://github.com/alphagov/support/blob/37fa7b05ec92511361b2a5e85f2c9f1a1bb3fb51/app/models/zendesk/zendesk_ticket.rb#L50-L52).

## How Zendesk routes tickets

Tickets are created 'unassigned' and tagged as described above. Zendesk then routes the ticket to the correct group based on its tags.

For example, sticking with the content change request, we can see in this [example Zendesk ticket](https://govuk.zendesk.com/agent/tickets/5325939/events) that it was automatically triaged based on the [Gov't Form content change requests to 2nd Line--GOV.UK Content Triage, Gov't](https://govuk.zendesk.com/admin/objects-rules/rules/triggers/31640428) rule, which matches on unassigned tickets (`Group Is -`) that have the tags `content_amend` and `govuk_form`, to assign the ticket to the `2nd Line--GOV.UK Content Triage, Gov't` group. There are similar [rules for content advice](https://govuk.zendesk.com/admin/objects-rules/rules/triggers/45554483), [publisher technical fault requests](https://govuk.zendesk.com/admin/objects-rules/rules/triggers/35985647) and many more.

See all of the existing routing rules by visiting <https://govuk.zendesk.com/admin/objects-rules/rules/triggers/> and filtering by: Conditions -> Tags -> Contains at least one of the following -> `govt_form`.
